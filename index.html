<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASCII ÏïÑÌä∏ Ïª§ÎÆ§ÎãàÌã∞ (Í∞ÑÎã®Î≤ÑÏ†Ñ)</title>
  <style>
    :root{
      --bg:#0f1115; --card:#161a22; --muted:#8b97a7; --text:#e6edf3; --line:#232838; --accent:#6aa4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Helvetica, Arial;
      background:var(--bg); color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1000px; margin:0 auto; padding:24px}

    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px}
    header h1{font-size:20px; margin:0}
    header nav{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--line); background:linear-gradient(180deg,#1a2030,#141827); color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.secondary{background:#10131c}
    .btn.ghost{background:transparent}
    .btn.accent{background:linear-gradient(180deg,#2a68ff,#1b46b3); border-color:#1c3b82}

    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px}
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width: 900px){.grid.cols-2{grid-template-columns:1fr}}

    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="text"], input[type="search"], select, textarea{
      width:100%; background:#0d1018; color:var(--text); border:1px solid var(--line); border-radius:10px;
      padding:10px 12px; font-size:14px;
    }
    input[type="range"]{width:100%}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .hint{color:var(--muted); font-size:12px}

    pre.ascii{white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono CJK KR", monospace;
      line-height:1.05; letter-spacing:0.4px; overflow:auto; padding:12px; background:#0b0e15; border:1px dashed #2a3147; border-radius:12px; max-height:60vh}

    .post-item{display:flex; align-items:flex-start; gap:12px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#121726}
    .post-title{font-weight:700}
    .badge{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#cbd5e1; background:#0e1220}

    .comment{border-top:1px solid var(--line); padding-top:12px; margin-top:12px}
    .comment .meta{color:var(--muted); font-size:12px}
    .indent{border-left:2px solid #27304d; margin-left:12px; padding-left:12px}

    .empty{text-align:center; color:#94a3b8; padding:28px}
    .divider{height:1px; background:var(--line); margin:12px 0}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><a href="#/">üñºÔ∏è‚û°Ô∏èüÖ∞Ô∏è ASCII ÏïÑÌä∏</a></h1>
      <nav>
        <button class="btn ghost" id="navHome">ÏÉùÏÑ±Í∏∞</button>
        <button class="btn ghost" id="navList">Í≤åÏãúÍ∏Ä</button>
        <a class="btn ghost" href="https://github.com/new" target="_blank" title="GitHub PagesÎ°ú Î∞∞Ìè¨ÌïòÍ∏∞">Î∞∞Ìè¨</a>
      </nav>
    </header>

    <main id="app" class="grid cols-2"></main>
  </div>

  <canvas id="work" style="display:none"></canvas>

  <script>
  (function(){
    const DB_KEY = 'ascii_db_v1';
    const NOW = () => new Date().toISOString();

    const defaultSettings = {
      width: 120,
      charset: "@#$Y!=+~- ", // ÎÅùÏóê Í≥µÎ∞±(ÌòπÏùÄ \u3164 '„Ö§') Í∂åÏû•
      invert: false,
      aspect: 0.5, // Î¨∏Ïûê ÏÑ∏Î°ú ÏïïÏ∂ï (0.4~0.6 Ï†ïÎèÑÍ∞Ä ÏùºÎ∞òÏ†Å)
      kindOptions: ['Í∏∞ÌÉÄ','Ïù∏Î¨º','ÌíçÍ≤Ω','ÎèôÎ¨º','ÌÖçÏä§Ï≤ò','Î¨∏ÏûêÏïÑÌä∏']
    };

    /** DB Ï¥àÍ∏∞Ìôî **/
    let db = JSON.parse(localStorage.getItem(DB_KEY) || 'null');
    if(!db){
      db = { posts: [], comments: {}, settings: defaultSettings };
      save();
    } else {
      db.settings = Object.assign({}, defaultSettings, db.settings || {});
    }

    function save(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }

    /** ÎùºÏö∞ÌåÖ **/
    window.addEventListener('hashchange', render);
    document.getElementById('navHome').onclick = () => { location.hash = '#/'; };
    document.getElementById('navList').onclick = () => { location.hash = '#/list'; };

    const app = document.getElementById('app');

    function render(){
      const hash = location.hash.replace(/^#/, '') || '/';
      if(hash.startsWith('/post/')){
        const id = hash.split('/')[2];
        renderPost(id);
      } else if(hash.startsWith('/list')){
        renderList();
      } else {
        renderHome();
      }
    }

    /** Ïù¥ÎØ∏ÏßÄ -> ASCII **/
    async function fileToImage(file){
      return new Promise((res,rej)=>{
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        const url = URL.createObjectURL(file);
        img.src = url;
      });
    }

    function imageToAscii(img, width, charset, invert, aspect){
      const canvas = document.getElementById('work');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      const scale = img.width / width;
      const h = Math.max(1, Math.round((img.height / scale) * aspect));
      canvas.width = width;
      canvas.height = h;

      // Îã§Ïö¥Ïä§ÏºÄÏùºÎßÅ
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(img, 0, 0, width, h);

      const { data } = ctx.getImageData(0, 0, width, h);
      const chars = [...charset];
      const n = chars.length;
      const out = [];

      for(let y=0; y<h; y++){
        let line = '';
        for(let x=0; x<width; x++){
          const i = (y*width + x)*4;
          const r = data[i], g = data[i+1], b = data[i+2];
          const lum = 0.299*r + 0.587*g + 0.114*b; // Î∞ùÍ∏∞
          let idx = Math.floor(lum / 256 * n);
          if(idx >= n) idx = n-1;
          if(!invert) idx = (n-1) - idx; // Ïñ¥ÎëêÏö∏ÏàòÎ°ù Î¨¥Í±∞Ïö¥ Î¨∏Ïûê
          line += chars[idx];
        }
        out.push(line);
      }
      return out.join('\n');
    }

    /** Í≥µÌÜµ UI Ï°∞Í∞Å **/
    function el(tag, attrs={}, children=[]) {
      const node = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k === 'class') node.className = v;
        else if(k === 'html') node.innerHTML = v;
        else if(k.startsWith('on') && typeof v === 'function') node[k] = v;
        else node.setAttribute(k, v);
      }
      for(const c of [].concat(children)){
        if(c==null) continue;
        node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      }
      return node;
    }

    function copyText(text){
      if(!navigator.clipboard){
        const ta = el('textarea', {style:'position:fixed;left:-9999px;top:-9999px'}); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        return;
      }
      return navigator.clipboard.writeText(text);
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = el('a', {href:url, download:filename});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /** Ìôà(ÏÉùÏÑ±Í∏∞) ÌôîÎ©¥ **/
    function renderHome(){
      app.className = 'grid cols-2';
      app.innerHTML = '';

      const left = el('section', {class:'card'}, [
        el('h2', {style:'margin:0 0 8px 0'}, ['Ïù¥ÎØ∏ÏßÄ ‚Üí ASCII Î≥ÄÌôòÍ∏∞']),
        el('p', {class:'hint'}, ['Ïù¥ÎØ∏ÏßÄÎ•º Ïò¨Î¶¨Í≥†, Ìï¥ÏÉÅÎèÑ/Î¨∏ÏûêÏÖãÏùÑ Ï°∞Ï†ïÌïú Îí§ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.']) ,
        el('div', {class:'grid'}, [
          el('div', {}, [
            el('label', {}, ['Ïù¥ÎØ∏ÏßÄ ÌååÏùº']),
            el('input', {type:'file', accept:'image/*', id:'file'})
          ]),
          el('div', {}, [
            el('label', {}, ['Í∞ÄÎ°ú Î¨∏Ïûê Ïàò (Ìï¥ÏÉÅÎèÑ)']),
            el('input', {type:'range', min:'40', max:'240', value:db.settings.width, id:'rangeW'}),
            el('div', {class:'hint', id:'wHint'}, [`${db.settings.width} chars`])
          ]),
          el('div', {}, [
            el('label', {}, ['Î¨∏ÏûêÏÖã (Ïñ¥ÎëêÏõÄ‚ÜíÎ∞ùÏùå)']),
            el('input', {type:'text', value:db.settings.charset, id:'charset'}),
            el('div', {class:'hint'}, ['Ïòà: @#$Y!=+~-‚ê† (ÎÅùÏóê Í≥µÎ∞± Ìè¨Ìï® Í∂åÏû•)'])
          ]),
          el('div', {}, [
            el('label', {}, ['ÏÑ∏Î°ú ÏïïÏ∂ï(Î¨∏Ïûê ÎπÑÏú®)']),
            el('input', {type:'range', min:'0.35', max:'1.00', step:'0.01', value:db.settings.aspect, id:'rangeA'}),
            el('div', {class:'hint', id:'aHint'}, [`${db.settings.aspect}`])
          ]),
          el('div', {class:'row'}, [
            el('label', {}, [el('input', {type:'checkbox', id:'invert', checked: db.settings.invert}), ' Î∞ùÍ∏∞ Î∞òÏ†Ñ(Î∞ùÏùÄ Î∞∞Í≤Ω)'])
          ]),
          el('div', {class:'row'}, [
            el('button', {class:'btn accent', id:'btnGen'}, ['ASCII ÏÉùÏÑ±']),
            el('button', {class:'btn', id:'btnCopy', disabled:true}, ['Î≥µÏÇ¨']),
            el('button', {class:'btn secondary', id:'btnDownload', disabled:true}, ['.txt Ï†ÄÏû•'])
          ])
        ])
      ]);

      const right = el('section', {class:'card'}, [
        el('div', {class:'row', style:'justify-content:space-between; align-items:center'}, [
          el('h2', {style:'margin:0'}, ['ÎØ∏Î¶¨Î≥¥Í∏∞']),
          el('div', {class:'row'}, [
            el('button', {class:'btn', id:'btnPost', disabled:true}, ['Ïù¥Í±∏Î°ú Í≤åÏãú ÌïòÍ∏∞'])
          ])
        ]),
        el('pre', {class:'ascii', id:'preview'}, ['(Ïó¨Í∏∞Ïóê Í≤∞Í≥ºÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§)'])
      ]);

      app.append(left, right);

      // ÏÉÅÌÉú ÏöîÏÜå
      const $file = left.querySelector('#file');
      const $rangeW = left.querySelector('#rangeW');
      const $rangeA = left.querySelector('#rangeA');
      const $wHint = left.querySelector('#wHint');
      const $aHint = left.querySelector('#aHint');
      const $charset = left.querySelector('#charset');
      const $invert = left.querySelector('#invert');
      const $btnGen = left.querySelector('#btnGen');
      const $btnCopy = left.querySelector('#btnCopy');
      const $btnDownload = left.querySelector('#btnDownload');
      const $btnPost = right.querySelector('#btnPost');
      const $preview = right.querySelector('#preview');

      let currentAscii = '';
      let lastImg = null;

      $rangeW.oninput = (e)=>{ $wHint.textContent = e.target.value + ' chars'; db.settings.width = +e.target.value; save(); };
      $rangeA.oninput = (e)=>{ $aHint.textContent = e.target.value; db.settings.aspect = +e.target.value; save(); };
      $charset.onchange = ()=>{ db.settings.charset = $charset.value; save(); };
      $invert.onchange = ()=>{ db.settings.invert = $invert.checked; save(); };

      $btnGen.onclick = async () => {
        if(!$file.files[0]){ alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.'); return; }
        $btnGen.disabled = true; $btnGen.textContent = 'ÏÉùÏÑ± Ï§ë...';
        try{
          lastImg = await fileToImage($file.files[0]);
          currentAscii = imageToAscii(
            lastImg,
            +$rangeW.value,
            $charset.value || defaultSettings.charset,
            $invert.checked,
            +$rangeA.value
          );
          $preview.textContent = currentAscii;
          $btnCopy.disabled = false; $btnDownload.disabled = false; $btnPost.disabled = false;
        }catch(err){
          console.error(err); alert('Î≥ÄÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }finally{
          $btnGen.disabled = false; $btnGen.textContent = 'ASCII ÏÉùÏÑ±';
        }
      };

      $btnCopy.onclick = ()=>{
        copyText(currentAscii).then(()=>{
          $btnCopy.textContent = 'Î≥µÏÇ¨Îê®!'; setTimeout(()=> $btnCopy.textContent = 'Î≥µÏÇ¨', 900);
        });
      };
      $btnDownload.onclick = ()=> downloadText('ascii-art.txt', currentAscii);

      $btnPost.onclick = ()=>{
        if(!currentAscii) return;
        openPostDialog(currentAscii);
      };
    }

    function openPostDialog(ascii){
      const modal = el('div', {style:'position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);z-index:50'});
      const kinds = db.settings.kindOptions;
      const card = el('div', {class:'card', style:'max-width:640px; width:92vw'}, [
        el('h3', {style:'margin-top:0'}, ['Í≤åÏãúÍ∏Ä ÎßåÎì§Í∏∞']),
        el('div', {class:'grid'}, [
          el('div', {}, [
            el('label', {}, ['Ï†úÎ™©']),
            el('input', {type:'text', id:'t', placeholder:'Ïòà: Ï≤´ ASCII ÏãúÎèÑ'})
          ]),
          el('div', {}, [
            el('label', {}, ['Î∂ÑÎ•ò(ÏïÑÏä§ÌÇ§ Ï¢ÖÎ•ò)']),
            (()=>{
              const s = el('select', {id:'k'});
              kinds.forEach(k=> s.appendChild(el('option', {value:k}, [k])));
              return s;
            })()
          ]),
          el('div', {}, [
            el('label', {}, ['ÏûëÏÑ±Ïûê(ÏÑ†ÌÉù)']),
            el('input', {type:'text', id:'n', placeholder:'ÎãâÎÑ§ÏûÑ ÏóÜÏúºÎ©¥ ÎπÑÏõåÎëêÍ∏∞'})
          ]),
        ]),
        el('div', {class:'divider'}),
        el('div', {class:'row', style:'justify-content:flex-end'}, [
          el('button', {class:'btn ghost', onclick:()=> modal.remove()}, ['Ï∑®ÏÜå']),
          el('button', {class:'btn accent', id:'ok'}, ['Í≤åÏãú'])
        ])
      ]);
      modal.appendChild(card); document.body.appendChild(modal);

      card.querySelector('#ok').onclick = ()=>{
        const title = card.querySelector('#t').value.trim() || 'Ï†úÎ™© ÏóÜÏùå';
        const kind = card.querySelector('#k').value;
        const author = card.querySelector('#n').value.trim();
        const post = { id: uid(), title, kind, ascii, createdAt: NOW(), width: db.settings.width, params: { charset: db.settings.charset, invert: db.settings.invert, aspect: db.settings.aspect }, author: author || null };
        db.posts.unshift(post); db.comments[post.id] = []; save();
        modal.remove();
        location.hash = '#/post/' + post.id;
      };
    }

    /** Í≤åÏãúÍ∏Ä Î™©Î°ù ÌôîÎ©¥ **/
    function renderList(){
      app.className = 'grid cols-1';
      app.innerHTML = '';

      const search = el('section', {class:'card'}, [
        el('div', {class:'row'}, [
          el('div', {style:'flex:1'}, [ el('label', {}, ['Í≤ÄÏÉâ']), el('input', {type:'search', id:'q', placeholder:'Ï†úÎ™©/ÎÇ¥Ïö©'}) ]),
          el('div', {}, [ el('label', {}, ['Î∂ÑÎ•ò']), (()=>{ const s=el('select',{id:'fk'}); ['Ï†ÑÏ≤¥',...db.settings.kindOptions].forEach(k=> s.appendChild(el('option',{value:k},[k]))); return s; })() ])
        ]),
        el('div', {class:'row', style:'justify-content:space-between; margin-top:8px'}, [
          el('span', {class:'hint'}, ['‚Äª Ïù¥ Î≤ÑÏ†ÑÏùÄ Î∏åÎùºÏö∞Ï†Ä Î°úÏª¨Ïóê Ï†ÄÏû•Îê©ÎãàÎã§. Îã§Î•∏ Í∏∞Í∏∞ÏôÄÎäî Í≥µÏú†ÎêòÏßÄ ÏïäÏïÑÏöî.']),
          el('div', {class:'row'}, [
            el('button', {class:'btn secondary', id:'export'}, ['ÎÇ¥Î≥¥ÎÇ¥Í∏∞(JSON)']),
            el('button', {class:'btn secondary', id:'import'}, ['Í∞ÄÏ†∏Ïò§Í∏∞'])
          ])
        ])
      ]);

      const list = el('section', {class:'grid', id:'list'});

      app.append(search, list);

      const $q = search.querySelector('#q');
      const $fk = search.querySelector('#fk');

      function draw(){
        list.innerHTML = '';
        const q = ($q.value||'').toLowerCase();
        const filterKind = $fk.value;
        const items = db.posts.filter(p=>{
          const okKind = (filterKind==='Ï†ÑÏ≤¥') || p.kind===filterKind;
          const hay = (p.title + ' ' + p.ascii).toLowerCase();
          const okQ = !q || hay.includes(q);
          return okKind && okQ;
        });
        if(!items.length){ list.appendChild(el('div',{class:'empty'},['Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§. ÏÉùÏÑ±Í∏∞ÏóêÏÑú Í≤åÏãúÌï¥ Î≥¥ÏÑ∏Ïöî.'])); return; }
        items.forEach(p=>{
          const comments = db.comments[p.id]||[];
          const item = el('div', {class:'post-item'}, [
            el('div', {style:'flex:1'}, [
              el('div', {class:'row', style:'justify-content:space-between'}, [
                el('div', {}, [ el('a', {href:'#/post/'+p.id, class:'post-title'}, [p.title]), ' ', el('span',{class:'badge'},[p.kind]) ]),
                el('div', {class:'hint'}, [new Date(p.createdAt).toLocaleString(), ' ¬∑ ÎåìÍ∏Ä ', String(comments.length)])
              ]),
              el('pre', {class:'ascii', style:'max-height:220px'}, [p.ascii.slice(0, 4000)])
            ]),
            el('div', {class:'row', style:'flex-direction:column; gap:8px'}, [
              el('button', {class:'btn', onclick:()=>{ copyText(p.ascii); }}, ['Î≥µÏÇ¨'])
            ])
          ]);
          list.appendChild(item);
        });
      }

      $q.oninput = draw; $fk.onchange = draw; draw();

      // Export/Import
      search.querySelector('#export').onclick = ()=>{
        downloadText('ascii-db-export.json', JSON.stringify(db, null, 2));
      };
      search.querySelector('#import').onclick = ()=>{
        const inp = el('input', {type:'file', accept:'application/json'});
        inp.onchange = async () => {
          const file = inp.files[0]; if(!file) return;
          const text = await file.text();
          try{ const incoming = JSON.parse(text); if(!incoming.posts || !incoming.comments) throw new Error('ÌòïÏãù Ïò§Î•ò');
            db = incoming; save(); renderList(); alert('Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å');
          }catch(e){ alert('Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: '+e.message); }
        };
        inp.click();
      };
    }

    /** ÎåìÍ∏Ä Ïú†Ìã∏: ÏùµÎ™ÖN ÌëúÏãú **/
    function getDisplayNameForComment(postId, c){
      if(c.nickname && c.nickname.trim()) return c.nickname.trim();
      // Ïù¥ ÎåìÍ∏ÄÏù¥ Î™á Î≤àÏß∏ Î¨¥ÎãâÏù∏ÏßÄ Í≥ÑÏÇ∞
      const all = db.comments[postId]||[];
      let idx = 0;
      for(const x of all){
        if(x === c) break;
        if(!x.nickname || !x.nickname.trim()) idx++;
      }
      return 'ÏùµÎ™Ö' + (idx+1);
    }

    /** Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ ÌôîÎ©¥ **/
    function renderPost(id){
      const post = db.posts.find(p=> p.id===id);
      app.className = 'grid cols-1';
      app.innerHTML = '';
      if(!post){ app.appendChild(el('div', {class:'empty'}, ['Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'])); return; }

      const head = el('section', {class:'card'}, [
        el('div', {class:'row', style:'justify-content:space-between; align-items:center'}, [
          el('div', {}, [
            el('div', {class:'row', style:'gap:8px; align-items:center'}, [
              el('h2', {style:'margin:0'}, [post.title]),
              el('span', {class:'badge'}, [post.kind])
            ]),
            el('div', {class:'hint'}, [
              'ÏûëÏÑ±: ', new Date(post.createdAt).toLocaleString(),
              post.author ? ' ¬∑ ÏûëÏÑ±Ïûê: ' + post.author : ''
            ])
          ]),
          el('div', {class:'row'}, [
            el('button', {class:'btn', onclick:()=>{ copyText(post.ascii); }}, ['Î≥µÏÇ¨']),
            el('button', {class:'btn secondary', onclick:()=> downloadText((post.title||'ascii')+'.txt', post.ascii)}, ['.txt Ï†ÄÏû•']),
            el('button', {class:'btn ghost', onclick:()=>{ location.hash = '#/list'; }}, ['Î™©Î°ù'])
          ])
        ])
      ]);

      const body = el('section', {class:'card'}, [
        el('pre', {class:'ascii'}, [post.ascii])
      ]);

      const commentsSec = el('section', {class:'card'}, [
        el('h3', {}, ['ÎåìÍ∏Ä']),
        el('div', {id:'comments'}),
        el('div', {class:'divider'}),
        el('div', {}, [
          el('label', {}, ['ÎãâÎÑ§ÏûÑ(ÏÑ†ÌÉù)']),
          el('input', {type:'text', id:'nick', placeholder:'ÎπÑÏö∞Î©¥ ÏùµÎ™Ö1, ÏùµÎ™Ö2...'}),
          el('label', {style:'margin-top:8px'}, ['ÎÇ¥Ïö©']),
          el('textarea', {id:'cbody', rows:'3', placeholder:'Ïπ≠Ï∞¨Í≥º ÌîºÎìúÎ∞±ÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî.'}),
          el('div', {class:'row', style:'justify-content:flex-end; margin-top:8px'}, [
            el('button', {class:'btn accent', id:'csubmit'}, ['ÎåìÍ∏Ä Îì±Î°ù'])
          ])
        ])
      ]);

      app.append(head, body, commentsSec);

      function drawComments(){
        const wrap = commentsSec.querySelector('#comments');
        wrap.innerHTML = '';
        const list = (db.comments[id]||[]);
        if(!list.length){ wrap.appendChild(el('div', {class:'empty'}, ['ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.'])); return; }

        // Ìä∏Î¶¨Î°ú Î†åÎçîÎßÅ
        const byParent = new Map();
        list.forEach(c=>{
          const k = c.parentId || 'root';
          if(!byParent.has(k)) byParent.set(k, []);
          byParent.get(k).push(c);
        });

        function node(c, depth){
          const who = getDisplayNameForComment(id, c);
          const box = el('div', {class:'comment' + (depth? ' indent':'')}, [
            el('div', {class:'meta'}, [who,' ¬∑ ', new Date(c.createdAt).toLocaleString()]),
            el('div', {style:'white-space:pre-wrap; margin-top:6px'}, [c.text])
          ]);
          const actions = el('div', {class:'row', style:'gap:8px; margin-top:6px'}, [
            el('button', {class:'btn ghost', onclick:()=> openReply(c.id)}, ['ÎãµÍ∏Ä'])
          ]);
          box.appendChild(actions);
          const kids = byParent.get(c.id)||[];
          kids.forEach(k => box.appendChild(node(k, depth+1)));
          return box;
        }

        (byParent.get('root')||[]).forEach(c=> wrap.appendChild(node(c, 0)));
      }

      function openReply(parentId){
        const modal = el('div', {style:'position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);z-index:50'});
        const card = el('div', {class:'card', style:'max-width:560px; width:92vw'}, [
          el('h3', {style:'margin:0 0 8px 0'}, ['ÎãµÍ∏Ä Îã¨Í∏∞']),
          el('label', {}, ['ÎãâÎÑ§ÏûÑ(ÏÑ†ÌÉù)']),
          el('input', {type:'text', id:'n'}),
          el('label', {style:'margin-top:8px'}, ['ÎÇ¥Ïö©']),
          el('textarea', {id:'t', rows:'3'}),
          el('div', {class:'row', style:'justify-content:flex-end; margin-top:8px'}, [
            el('button', {class:'btn ghost', onclick:()=> modal.remove()}, ['Ï∑®ÏÜå']),
            el('button', {class:'btn accent', onclick:()=>{
              const txt = card.querySelector('#t').value.trim();
              const name = card.querySelector('#n').value.trim();
              if(!txt) return;
              const c = { id: uid(), parentId, text: txt, nickname: name||'', createdAt: NOW() };
              if(!db.comments[id]) db.comments[id] = [];
              db.comments[id].push(c); save(); modal.remove(); drawComments();
            }}, ['Îì±Î°ù'])
          ])
        ]);
        modal.appendChild(card); document.body.appendChild(modal);
      }

      commentsSec.querySelector('#csubmit').onclick = ()=>{
        const nick = commentsSec.querySelector('#nick').value.trim();
        const text = commentsSec.querySelector('#cbody').value.trim();
        if(!text) return;
        const c = { id: uid(), parentId: null, text, nickname: nick||'', createdAt: NOW() };
        if(!db.comments[id]) db.comments[id] = [];
        db.comments[id].push(c); save();
        commentsSec.querySelector('#cbody').value = '';
        drawComments();
      };

      drawComments();
    }

    // Ï¥àÍ∏∞ Î†åÎçî
    render();
  })();
  </script>
</body>
</html>
